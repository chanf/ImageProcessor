<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>简易图片处理工具</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        h1 { color: #333; }
        .container { display: flex; gap: 20px; width: 100%; max-width: 1200px; flex-wrap: wrap; }
        .controls { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); width: 300px; min-width: 280px; display: flex; flex-direction: column; }
        .canvas-container { flex-grow: 1; background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 400px; min-width: 300px; }
        #resolution-display { margin-top: 10px; color: #555; font-size: 0.9em; height: 20px; }
        canvas { max-width: 100%; height: auto; border: 1px dashed #ccc; cursor: crosshair; }
        button, input[type="file"], input[type="number"] { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        button { background-color: #007bff; color: white; border: none; cursor: pointer; transition: background-color 0.3s; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #a0a0a0; cursor: not-allowed; }
        .download-btn { background-color: #28a745; margin-top: 15px; }
        .download-btn:hover { background-color: #218838; }
        .control-group { display: flex; flex-direction: column; gap: 8px; margin-bottom: 10px;}
        label { font-weight: bold; font-size: 0.9em; color: #555; }
        #loader { display: none; text-align: center; padding: 20px; }

        /* Tab Styles */
        .tab-buttons { display: flex; flex-wrap: wrap; border-bottom: 1px solid #ccc; }
        .tab-button { flex-grow: 1; padding: 10px; background-color: #e0e0e0; color: #333; font-weight: bold; border: 1px solid #ccc; border-bottom: none; cursor: pointer; border-radius: 4px 4px 0 0; width: auto; margin-bottom: -1px; transition: background-color 0.3s, color 0.3s; font-size: 0.8em; text-align: center; }
        .tab-button:hover { background-color: #d0d0d0; }
        .tab-button.active { background-color: #fff; color: #007bff; border-bottom: 1px solid #fff; }
        .tab-content { display: none; flex-direction: column; gap: 15px; padding-top: 15px; }
        .tab-content.active { display: flex; }
        .button-grid { display: flex; flex-wrap: wrap; gap: 5px; }
        .button-grid > button { flex: 1 1 calc(50% - 5px); }

        /* Pro Mode & Preset Styles */
        .preset-grid { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 15px;}
        .preset-btn { background-color: #f0f2f5; color: #333; border: 1px solid #ddd; font-size: 0.8em; padding: 5px 8px; flex-grow: 1; }
        .preset-btn:hover { background-color: #e0e0e0; border-color: #ccc; }
        .pro-control { display: flex; flex-direction: column; gap: 5px; margin-bottom: 5px;}
        .pro-control .label-container { display: flex; justify-content: space-between; align-items: center; }
        .pro-control .slider-value { font-size: 0.8em; color: #888; background-color: #f0f2f5; padding: 2px 6px; border-radius: 4px;}
        input[type="range"] { width: 100%; -webkit-appearance: none; appearance: none; height: 8px; background: #ddd; border-radius: 5px; outline: none; transition: opacity .2s; margin: 0;}
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 18px; height: 18px; background: #007bff; cursor: pointer; border-radius: 50%; }
        input[type="range"]::-moz-range-thumb { width: 18px; height: 18px; background: #007bff; cursor: pointer; border-radius: 50%; }
        #btn-pro-reset { background-color: #6c757d; margin-top: 10px; }
        #btn-pro-reset:hover { background-color: #5a6268; }
    </style>
</head>
<body>

    <h1>简易图片处理工具</h1>

    <div class="container">
        <div class="controls">
            <div class="control-group"><label for="imageLoader">1. 上传图片</label><input type="file" id="imageLoader" name="imageLoader" accept="image/*"/></div>
            <button id="btn-undo" disabled>撤销</button>

            <div class="tab-buttons">
                <button class="tab-button active" data-tab="tab-basic">基本</button>
                <button class="tab-button" data-tab="tab-pro">专业</button>
                <button class="tab-button" data-tab="tab-adjust">调整</button>
                <button class="tab-button" data-tab="tab-filters">滤镜</button>
            </div>

            <div class="tab-content-container">
                <div id="tab-basic" class="tab-content active">
                    <div class="control-group"><label>变换</label><button id="btn-trim" disabled>裁剪透明</button><div style="display: flex; gap: 5px;"><button id="btn-flip" disabled>左右翻转</button><button id="btn-flip-vertical" disabled>上下翻转</button></div></div>
                    <div class="control-group"><label for="rotateAngle">任意旋转</label><input type="number" id="rotateAngle" placeholder="输入角度, 如: 90, -45" value="0"><button id="btn-rotate" disabled>确认</button></div>
                    <div class="control-group"><label for="resizeWidth">等比缩放</label><input type="number" id="resizeWidth" placeholder="输入新宽度 (px)" min="1"><button id="btn-resize" disabled>确认</button></div>
                    <div class="control-group"><label>区域裁剪</label><button id="btn-crop" disabled>裁剪选中区域</button></div>
                </div>

                <div id="tab-pro" class="tab-content">
                    <div class="preset-grid">
                        <button class="preset-btn" data-preset="blackGold" disabled>万物黑金</button>
                        <button class="preset-btn" data-preset="anime" disabled>动漫风</button>
                        <button class="preset-btn" data-preset="insWhite" disabled>INS净白</button>
                    </div>
                    <div class="pro-control"><div class="label-container"><label for="pro-exposure">曝光</label><span class="slider-value" id="val-pro-exposure">0</span></div><input type="range" id="pro-exposure" min="-100" max="100" value="0"></div>
                    <div class="pro-control"><div class="label-container"><label for="pro-temperature">色温</label><span class="slider-value" id="val-pro-temperature">0</span></div><input type="range" id="pro-temperature" min="-100" max="100" value="0"></div>
                    <div class="pro-control"><div class="label-container"><label for="pro-contrast">对比度</label><span class="slider-value" id="val-pro-contrast">0</span></div><input type="range" id="pro-contrast" min="-100" max="100" value="0"></div>
                    <div class="pro-control"><div class="label-container"><label for="pro-highlights">高光</label><span class="slider-value" id="val-pro-highlights">0</span></div><input type="range" id="pro-highlights" min="-100" max="100" value="0"></div>
                    <div class="pro-control"><div class="label-container"><label for="pro-shadows">阴影</label><span class="slider-value" id="val-pro-shadows">0</span></div><input type="range" id="pro-shadows" min="-100" max="100" value="0"></div>
                    <div class="pro-control"><div class="label-container"><label for="pro-vibrance">自然饱和度</label><span class="slider-value" id="val-pro-vibrance">0</span></div><input type="range" id="pro-vibrance" min="-100" max="100" value="0"></div>
                    <div class="pro-control"><div class="label-container"><label for="pro-saturation">饱和度</label><span class="slider-value" id="val-pro-saturation">0</span></div><input type="range" id="pro-saturation" min="-100" max="100" value="0"></div>
                    <div class="pro-control"><div class="label-container"><label for="pro-clarity">清晰度</label><span class="slider-value" id="val-pro-clarity">0</span></div><input type="range" id="pro-clarity" min="-100" max="100" value="0"></div>
                    <button id="btn-pro-reset" disabled>全部重置</button>
                </div>

                <div id="tab-adjust" class="tab-content">
                    <div class="control-group"><label for="saturationFactor">饱和度 (0-2)</label><input type="number" id="saturationFactor" value="1.0" min="0" max="2" step="0.1"><button id="btn-saturation" disabled>调整</button></div>
                    <div class="control-group"><label for="brightnessFactor">亮度 (0-2)</label><input type="number" id="brightnessFactor" value="1.0" min="0" max="2" step="0.1"><button id="btn-brightness" disabled>调整</button></div>
                    <div class="control-group"><label for="contrastFactor">对比度 (0-2)</label><input type="number" id="contrastFactor" value="1.0" min="0" max="2" step="0.1"><button id="btn-contrast" disabled>调整</button></div>
                    <div class="control-group"><label for="sharpnessFactor">清晰度 (0-2)</label><input type="number" id="sharpnessFactor" value="1.0" min="0" max="2" step="0.1"><button id="btn-sharpness" disabled>调整</button></div>
                </div>

                <div id="tab-filters" class="tab-content">
                    <div class="control-group"><div class="button-grid">
                        <button id="btn-filter-grayscale" disabled>黑白</button><button id="btn-filter-sepia" disabled>复古</button>
                        <button id="btn-filter-invert" disabled>反色</button><button id="btn-filter-sharpen" disabled>锐化</button>
                        <button id="btn-filter-blur" disabled>模糊</button><button id="btn-filter-contour" disabled>轮廓</button>
                        <button id="btn-filter-edge-enhance" disabled>边缘增强</button><button id="btn-filter-emboss" disabled>浮雕</button>
                        <button id="btn-filter-detail" disabled>细节</button><button id="btn-filter-smooth" disabled>平滑</button>
                    </div></div>
                </div>
            </div>

            <a id="download" href="#" download="processed-image.png"><button class="download-btn" id="btn-download" disabled>下载处理后的图片</button></a>
            <div id="loader">正在处理...</div>
        </div>

        <div class="canvas-container"><canvas id="imageCanvas"></canvas><div id="resolution-display">请先上传图片</div></div>
    </div>

    <script>
        const imageLoader = document.getElementById('imageLoader');
        const canvas = document.getElementById('imageCanvas');
        const ctx = canvas.getContext('2d');
        const downloadLink = document.getElementById('download');
        const resolutionDisplay = document.getElementById('resolution-display');
        
        const actionButtons = ['btn-trim', 'btn-flip', 'btn-flip-vertical', 'btn-rotate', 'btn-saturation', 'btn-brightness', 'btn-contrast', 'btn-sharpness', 'btn-filter-grayscale', 'btn-filter-sepia', 'btn-filter-invert', 'btn-filter-sharpen', 'btn-filter-blur', 'btn-filter-contour', 'btn-filter-edge-enhance', 'btn-filter-emboss', 'btn-filter-detail', 'btn-filter-smooth', 'btn-resize', 'btn-crop', 'btn-download', 'btn-undo', 'btn-pro-reset'];
        const proSliders = document.querySelectorAll('#tab-pro input[type="range"]');
        const presetButtons = document.querySelectorAll('.preset-btn');

        let selection = { x: 0, y: 0, width: 0, height: 0, isSelecting: false };
        let originalImage = null; // Always holds the last state from history
        let pristineImage = null; // Holds the originally uploaded image, used for Pro adjustments
        let historyStack = [];
        const undoButton = document.getElementById('btn-undo');

        const presets = {
            blackGold: {
                exposure: -10, contrast: 20, saturation: -40, vibrance: 20, temperature: 15, shadows: 10,
                hsl: { yellow: { h: -10, s: 50, l: 5 }, blue: { h: 0, s: -80, l: -30 }, red: { s: -20 }, green: {s: -50} }
            },
            anime: {
                exposure: 5, contrast: 15, saturation: 25, vibrance: 15, clarity: 20, highlights: -10, shadows: 10,
                hsl: { cyan: { h: -5, s: 10, l: 0 }, blue: { h: -5, s: 15, l: 5 } }
            },
            insWhite: {
                exposure: 15, contrast: -15, saturation: -30, highlights: 10, shadows: 25, temperature: -10, clarity: 5,
            }
        };

        function debounce(func, delay) { let timeout; return function(...args) { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), delay); }; }

        function updateHistory(newImageSrc, fromProAdjust = false, presetName = null) {
            const lastState = historyStack.length > 0 ? historyStack[historyStack.length - 1] : null;
            const newState = { src: newImageSrc, pro: fromProAdjust, preset: presetName ? presets[presetName] : null };
            if (fromProAdjust && lastState?.pro) {
                historyStack[historyStack.length - 1] = newState;
            } else {
                historyStack.push(newState);
            }
            undoButton.disabled = historyStack.length <= 1;
        }

        imageLoader.addEventListener('change', e => {
            const reader = new FileReader();
            reader.onload = event => {
                pristineImage = new Image();
                pristineImage.onload = () => {
                    // Auto-resize logic
                    const MAX_DIMENSION = 1920;
                    let w = pristineImage.width;
                    let h = pristineImage.height;
                    if (w > MAX_DIMENSION || h > MAX_DIMENSION) {
                        if (w > h) {
                            h = Math.round(h * (MAX_DIMENSION / w));
                            w = MAX_DIMENSION;
                        } else {
                            w = Math.round(w * (MAX_DIMENSION / h));
                            h = MAX_DIMENSION;
                        }
                        const tempCanvas = document.createElement('canvas');
                        tempCanvas.width = w;
                        tempCanvas.height = h;
                        const tempCtx = tempCanvas.getContext('2d');
                        tempCtx.drawImage(pristineImage, 0, 0, w, h);
                        pristineImage.src = tempCanvas.toDataURL('image/png');
                        // We need to wait for the resized image to load before proceeding
                        pristineImage.onload = () => {
                            initImageState();
                        }
                    } else {
                       initImageState();
                    }
                }
                pristineImage.src = event.target.result;
            }
            reader.readAsDataURL(e.target.files[0]);
        });
        
        function initImageState() {
             historyStack = [];
            resetProSliders(false);
            updateHistory(pristineImage.src);
            drawImageOnCanvas(pristineImage.src);
            enableButtons(true);
        }

        undoButton.addEventListener('click', () => {
            if (historyStack.length <= 1) return;
            showLoader(true);
            historyStack.pop();
            const prevState = historyStack[historyStack.length - 1];
            drawImageOnCanvas(prevState.src, () => {
                undoButton.disabled = historyStack.length <= 1;
                showLoader(false);
            });
        });
        
        function applyPreset(presetName) {
            const preset = presets[presetName];
            if (!preset) return;
            resetProSliders(false); 
            for (const key in preset) {
                if (key === 'hsl') continue;
                const slider = document.getElementById(`pro-${key}`);
                if (slider) {
                    slider.value = preset[key];
                    document.getElementById(`val-pro-${key}`).textContent = preset[key];
                }
            }
            handleProAdjust(false, presetName);
        }

        presetButtons.forEach(btn => btn.addEventListener('click', () => applyPreset(btn.dataset.preset)));

        const handleProAdjust = async (isReset = false, presetName = null) => {
            if (!pristineImage) return;
            let adjustments = {};
            let isPristine = true;
            
            proSliders.forEach(slider => {
                const value = parseFloat(slider.value);
                const key = slider.id.replace('pro-', '');
                adjustments[key] = value;
                if (value !== 0) isPristine = false;
            });
            
            if (presetName && presets[presetName]) {
                 adjustments = { ...adjustments, ...presets[presetName] };
                 isPristine = false;
            } else if (!isPristine) {
                const lastState = historyStack[historyStack.length-1];
                if(lastState?.pro && lastState.preset?.hsl) {
                    adjustments.hsl = lastState.preset.hsl;
                }
            }

            if (isReset) {
                adjustments = { hsl: {} }; // Send empty adjustments to revert
                isPristine = true;
            }

            if (isPristine) {
                 drawImageOnCanvas(pristineImage.src, () => updateHistory(pristineImage.src, true, null));
                return;
            }

            const body = { adjustments };
            await callApi('/api/pro_adjust', body, pristineImage.src, true, presetName);
        };

        const debouncedProAdjust = debounce(handleProAdjust, 250);

        proSliders.forEach(slider => {
            slider.addEventListener('input', () => {
                document.getElementById(`val-${slider.id}`).textContent = slider.value;
                debouncedProAdjust();
            });
        });

        function resetProSliders(applyEffect = true) {
            proSliders.forEach(slider => {
                slider.value = 0;
                document.getElementById(`val-${slider.id}`).textContent = '0';
            });
            if (applyEffect) handleProAdjust(true);
        }

        document.getElementById('btn-pro-reset').addEventListener('click', () => resetProSliders(true));

        document.querySelectorAll('#tab-filters button').forEach(button => button.addEventListener('click', () => callApi(`/api/filter/${button.id.replace('btn-filter-', '')}`)));
        document.getElementById('btn-trim').addEventListener('click', () => callApi('/api/trim'));
        document.getElementById('btn-flip').addEventListener('click', () => callApi('/api/flip'));
        document.getElementById('btn-flip-vertical').addEventListener('click', () => callApi('/api/flip_vertical'));
        document.getElementById('btn-rotate').addEventListener('click', () => { const angle = document.getElementById('rotateAngle').value; if (angle === null || angle === '') { alert('Angle required.'); return; } callApi('/api/rotate', { angle: parseFloat(angle) }); });
        document.getElementById('btn-resize').addEventListener('click', () => { const width = document.getElementById('resizeWidth').value; if (!width || width <= 0) { alert('Width required.'); return; } callApi('/api/resize', { width }); });
        document.getElementById('btn-crop').addEventListener('click', () => { if (selection.width === 0 || selection.height === 0) { alert('Crop area required.'); return; } const params = { x: Math.round(Math.min(selection.x, selection.x + selection.width)), y: Math.round(Math.min(selection.y, selection.y + selection.height)), width: Math.round(Math.abs(selection.width)), height: Math.round(Math.abs(selection.height)) }; if (params.width === 0 || params.height === 0) { alert('Crop area cannot be zero.'); return; } callApi('/api/crop', params); selection = { x: 0, y: 0, width: 0, height: 0, isSelecting: false }; });
        document.querySelectorAll('#tab-adjust button').forEach(button => button.addEventListener('click', () => { const name = button.id.replace('btn-', ''); const factor = document.getElementById(`${name}Factor`).value; if (factor === null || factor === '' || parseFloat(factor) < 0) { alert('Factor required.'); return; } callApi(`/api/adjust/${name}`, { factor: parseFloat(factor) }); }));
        
        canvas.addEventListener('mousedown', e => { selection.isSelecting = true; const rect = canvas.getBoundingClientRect(); selection.x = e.offsetX * (canvas.width / rect.width); selection.y = e.offsetY * (canvas.height / rect.height); });
        canvas.addEventListener('mousemove', e => { if (selection.isSelecting) { drawImageOnCanvas(originalImage.src); const rect = canvas.getBoundingClientRect(); const currentX = e.offsetX * (canvas.width / rect.width); const currentY = e.offsetY * (canvas.height / rect.height); selection.width = currentX - selection.x; selection.height = currentY - selection.y; ctx.strokeStyle = 'red'; ctx.lineWidth = 2; ctx.strokeRect(selection.x, selection.y, selection.width, selection.height); } });
        canvas.addEventListener('mouseup', () => { selection.isSelecting = false; });

        function drawImageOnCanvas(src, callback) {
            const img = new Image();
            img.onload = () => {
                originalImage = img;
                canvas.width = img.width; canvas.height = img.height;
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0);
                updateDownloadLink(src);
                resolutionDisplay.textContent = `Resolution: ${img.width}x${img.height}`;
                if (callback) callback();
            };
            img.src = src;
        }

        function enableButtons(enabled) {
            actionButtons.forEach(id => { const button = document.getElementById(id); if (button) button.disabled = !enabled; });
            proSliders.forEach(slider => slider.disabled = !enabled);
            presetButtons.forEach(btn => btn.disabled = !enabled);
        }
        
        function showLoader(show) { document.getElementById('loader').style.display = show ? 'block' : 'none'; }
        function updateDownloadLink(dataUrl) { downloadLink.href = dataUrl; }

        async function callApi(endpoint, body = {}, imageSrc = null, fromPro = false, presetName = null) {
            showLoader(true);
            enableButtons(false);
            try {
                const src = imageSrc || (originalImage ? originalImage.src : null);
                if (!src) throw new Error("No image loaded.");
                const payload = { ...body, imageData: src };
                const response = await fetch(endpoint, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) { const error = await response.json(); throw new Error(error.error || `Request failed: ${response.status}`); }
                const result = await response.json();
                drawImageOnCanvas(result.imageUrl, () => {
                    showLoader(false);
                    enableButtons(true);
                    updateHistory(result.imageUrl, fromPro, presetName);
                });
            } catch (error) {
                alert(`Error: ${error.message}`);
                showLoader(false);
                enableButtons(true);
            }
        }

        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        tabButtons.forEach(button => button.addEventListener('click', () => {
            tabButtons.forEach(btn => btn.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));
            button.classList.add('active');
            document.getElementById(button.dataset.tab).classList.add('active');
        }));
        
        enableButtons(false);
    </script>
</body>
</html>
