<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>简易图片处理工具</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        h1 { color: #333; }
        .container { display: flex; gap: 20px; width: 100%; max-width: 1200px; }
        .controls { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); width: 300px; min-width: 150px; display: flex; flex-direction: column; gap: 15px; }
        .canvas-container { flex-grow: 1; background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 400px; }
        #resolution-display { margin-top: 10px; color: #555; font-size: 0.9em; height: 20px; }
        canvas { max-width: 100%; height: auto; border: 1px dashed #ccc; cursor: crosshair; }
        button, input[type="file"], input[type="number"] { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        button { background-color: #007bff; color: white; border: none; cursor: pointer; transition: background-color 0.3s; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #a0a0a0; cursor: not-allowed; }
        .download-btn { background-color: #28a745; }
        .download-btn:hover { background-color: #218838; }
        .control-group { display: flex; flex-direction: column; gap: 5px; }
        label { font-weight: bold; font-size: 0.9em; color: #555; }
        #loader { display: none; text-align: center; padding: 20px; }
    </style>
</head>
<body>

    <h1>简易图片处理工具</h1>

    <div class="container">
        <div class="controls">
            <div class="control-group">
                <label for="imageLoader">1. 上传图片</label>
                <input type="file" id="imageLoader" name="imageLoader" accept="image/*"/>
            </div>

            <div class="control-group">
                <label>2. 执行操作</label>
                <button id="btn-trim" disabled>裁剪透明区域</button>
                <div style="display: flex; flex-direction: row; gap: 5px;">
                    <button id="btn-flip" disabled>左右翻转</button>
                    <button id="btn-flip-vertical" disabled>上下翻转</button>
                </div>
            </div>

            <div class="control-group">
                <label>图像调整</label>
                <label for="saturationFactor" style="font-weight: normal; font-size: 0.8em;">饱和度 (0-2)</label>
                <input type="number" id="saturationFactor" placeholder="1.0" value="1.0" min="0" max="2" step="0.1">
                <button id="btn-saturation" disabled>调整饱和度</button>
            </div>
            
            <div class="control-group">
                <label for="rotateAngle">任意角度旋转 (度)</label>
                <input type="number" id="rotateAngle" placeholder="例如: 90, -45" value="0">
                <button id="btn-rotate" disabled>确认旋转</button>
            </div>

            <div class="control-group">
                <label for="resizeWidth">按宽度等比缩放</label>
                <input type="number" id="resizeWidth" placeholder="输入新的宽度 (px)" min="1">
                <button id="btn-resize" disabled>确认缩放</button>
            </div>

            <div class="control-group">
                <label>区域裁剪 (在图上拖动选择)</label>
                <button id="btn-crop" disabled>裁剪选中区域</button>
            </div>

            <div class="control-group">
                <label>3. 下载图片</label>
                <a id="download" href="#" download="processed-image.png">
                    <button class="download-btn" id="btn-download" disabled>下载处理后的图片</button>
                </a>
            </div>
            <div id="loader">正在处理...</div>
        </div>

        <div class="canvas-container">
            <canvas id="imageCanvas"></canvas>
            <div id="resolution-display">请先上传图片</div>
        </div>
    </div>

    <script>
        const imageLoader = document.getElementById('imageLoader');
        const canvas = document.getElementById('imageCanvas');
        const ctx = canvas.getContext('2d');
        const downloadLink = document.getElementById('download');
        const resolutionDisplay = document.getElementById('resolution-display');
        
        const allButtons = document.querySelectorAll('button');
        const actionButtons = ['btn-trim', 'btn-flip', 'btn-flip-vertical', 'btn-rotate', 'btn-saturation', 'btn-resize', 'btn-crop', 'btn-download'];

        let selection = { x: 0, y: 0, width: 0, height: 0, isSelecting: false };
        let originalImage = null;

        // --- Event Listeners ---

        imageLoader.addEventListener('change', e => {
            const reader = new FileReader();
            reader.onload = event => {
                originalImage = new Image();
                originalImage.onload = () => {
                    drawImageOnCanvas(originalImage);
                    enableButtons(true);
                }
                originalImage.src = event.target.result;
            }
            reader.readAsDataURL(e.target.files[0]);
        });

        document.getElementById('btn-trim').addEventListener('click', () => callApi('/api/trim'));
        document.getElementById('btn-flip').addEventListener('click', () => callApi('/api/flip'));
        document.getElementById('btn-flip-vertical').addEventListener('click', () => callApi('/api/flip_vertical'));

        document.getElementById('btn-saturation').addEventListener('click', () => {
            const factor = document.getElementById('saturationFactor').value;
            if (factor === null || factor === '' || parseFloat(factor) < 0) {
                alert('请输入有效的饱和度因子 (大于等于0)。');
                return;
            }
            callApi('/api/adjust_saturation', { factor: parseFloat(factor) });
        });
        
        document.getElementById('btn-rotate').addEventListener('click', () => {
            const angle = document.getElementById('rotateAngle').value;
            if (angle === null || angle === '') {
                alert('请输入有效的旋转角度。');
                return;
            }
            callApi('/api/rotate', { angle: parseFloat(angle) });
        });

        document.getElementById('btn-resize').addEventListener('click', () => {
            const width = document.getElementById('resizeWidth').value;
            if (!width || width <= 0) {
                alert('请输入有效的宽度值。');
                return;
            }
            callApi('/api/resize', { width });
        });

        document.getElementById('btn-crop').addEventListener('click', () => {
            if (selection.width === 0 || selection.height === 0) {
                alert('请先在图片上拖动鼠标选择一个裁剪区域。');
                return;
            }
            
            const x1 = selection.x;
            const y1 = selection.y;
            const x2 = selection.x + selection.width;
            const y2 = selection.y + selection.height;

            const left = Math.min(x1, x2);
            const top = Math.min(y1, y2);
            const right = Math.max(x1, x2);
            const bottom = Math.max(y1, y2);

            const cropParams = {
                x: Math.round(left),
                y: Math.round(top),
                width: Math.round(right - left),
                height: Math.round(bottom - top)
            };

            if (cropParams.width === 0 || cropParams.height === 0) {
                alert('裁剪区域的宽度或高度不能为0。');
                return;
            }

            callApi('/api/crop', cropParams);
            // Reset selection to prevent red box from reappearing
            selection = { x: 0, y: 0, width: 0, height: 0, isSelecting: false };
        });


        // --- Canvas Selection Logic ---

        canvas.addEventListener('mousedown', e => {
            selection.isSelecting = true;
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            selection.x = e.offsetX * scaleX;
            selection.y = e.offsetY * scaleY;
        });

        canvas.addEventListener('mousemove', e => {
            if (selection.isSelecting) {
                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;
                const currentX = e.offsetX * scaleX;
                const currentY = e.offsetY * scaleY;

                drawImageOnCanvas(originalImage); // Redraw original to clear previous rect
                selection.width = currentX - selection.x;
                selection.height = currentY - selection.y;
                ctx.strokeStyle = 'red';
                ctx.lineWidth = 2;
                ctx.strokeRect(selection.x, selection.y, selection.width, selection.height);
            }
        });

        canvas.addEventListener('mouseup', e => {
            selection.isSelecting = false;
        });


        // --- Helper Functions ---

        function drawImageOnCanvas(image) {
            canvas.width = image.width;
            canvas.height = image.height;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(image, 0, 0);
            updateDownloadLink(image.src);
            resolutionDisplay.textContent = `当前分辨率: ${image.width} x ${image.height}`;
        }

        function enableButtons(enabled) {
            actionButtons.forEach(id => {
                document.getElementById(id).disabled = !enabled;
            });
        }
        
        function showLoader(show) {
            document.getElementById('loader').style.display = show ? 'block' : 'none';
        }

        function updateDownloadLink(dataUrl) {
            downloadLink.href = dataUrl;
        }

        async function callApi(endpoint, body = {}) {
            showLoader(true);
            enableButtons(false);

            try {
                if (!originalImage) {
                    throw new Error("No image loaded.");
                }

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ...body,
                        imageData: originalImage.src // Use the clean originalImage source
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || `请求失败，状态码: ${response.status}`);
                }

                const result = await response.json();
                
                originalImage = new Image();
                originalImage.onload = () => {
                    drawImageOnCanvas(originalImage);
                    showLoader(false);
                    enableButtons(true);
                }
                originalImage.src = result.imageUrl;

            } catch (error) {
                alert(`处理失败: ${error.message}`);
                showLoader(false);
                enableButtons(true);
            }
        }

        // Initially disable all action buttons
        enableButtons(false);

    </script>
</body>
</html>
